if(!self.define){let t,e={};const i=(i,s)=>(i=new URL(i+".js",s).href,e[i]||new Promise((e=>{if("document"in self){const t=document.createElement("script");t.src=i,t.onload=e,document.head.appendChild(t)}else t=i,importScripts(i),e()})).then((()=>{let t=e[i];if(!t)throw new Error(`Module ${i} didnâ€™t register its module`);return t})));self.define=(s,a)=>{const l=t||("document"in self?document.currentScript.src:"")||location.href;if(e[l])return;let r={};const h=t=>i(t,l),n={module:{uri:l},exports:r,require:h};e[l]=Promise.all(s.map((t=>n[t]||h(t)))).then((t=>(a(...t),r)))}}define(["./comlink-9648aa2d","./appearance-ffb0e256","./promise_despammer-c45d8fa6"],(function(t,e,i){"use strict";class s{constructor(t){this.id=t,this.is_loading=!1,this.icon_load_callbacks=[]}update(){this.data&&this._load_abort&&this._load_abort.abort("Data found elsewhere")}load(){this.is_loading||(async()=>{if(this.data||!this.load_url)return;let t=this.load_url;this.load_url=void 0;let e=this._load_abort=new AbortController;try{this.is_loading=!0;let i=await fetch(t,{signal:e.signal});if(!i.ok)throw new Error("Fetch returned ("+i.status+") "+i.statusText);let s=await i.blob();e==this._load_abort&&(this._load_abort=void 0),this.data||(this.data=s)}finally{e&&(e.abort("An error occured"),e==this._load_abort&&(this._load_abort=void 0)),this.is_loading=!1}})()}load_icon(t){if(this.loading_icon||void 0!==this.icon||!this.data)return;let e=this.data;this.loading_icon=e,(async()=>{try{let i=await t.load_icon(e);if(e==this.data){this.icon=i;for(let t of this.icon_load_callbacks)t()}}finally{this.loading_icon==e&&(this.loading_icon=void 0),this.icon||(this.icon=null)}})()}}function a(t,e){if(1==t.frames.length)return t.frames[0];let i=e%t.total_delay,s=0;for(let e=0;e<t.frames.length;e++){let a=t.frames[e];if(s+=a.delay,s>=i)return a}return t.frames[0]}class l extends class{constructor(t){this.root=new r(this,void 0,0,0,t),this.size_index=t}get size(){return 1<<this.size_index}alloc(t,e){let i=this.root;if(i)return i.alloc(t,e)}expand(){console.log("Resizing atlas to ",1,this.size<<1),this.size_index++;let t=this.root,e=new r(this,void 0,0,0,this.size_index);t&&(t.reserved||null!=t.children)&&e.make_children(t),this.root=e}}{constructor(t,e,i){super(t),this.hash_to_node=new Map,this.anim_dirs=[],this.static_copy_dirty=!1,this.size_limit=e,this.tex_index=i;let s=this.size;this.expand_command={cmd:"resizeatlas",index:this.tex_index,width:s,height:s}}alloc(t,e){if(t<1||e<1)return;let i=super.alloc(t,e);if(!i)for(;!i&&this.size_index<this.size_limit;)this.expand(),i=super.alloc(t,e);return i}expand(){super.expand();let t=this.size;this.expand_command={cmd:"resizeatlas",index:this.tex_index,width:t,height:t}}add_anim_dir(t){this.anim_dirs.push(t)}update_anim_dirs(t,e){var i;for(let s of this.anim_dirs){if((null===(i=s.atlas_node)||void 0===i?void 0:i.use_index)!=e)continue;let l=a(s,t);if(l==s.current_frame)continue;let r=l.atlas_node,h=s.atlas_node;r&&h&&(this.copy_within_command||(this.copy_within_command={cmd:"atlestexcopywithin",index:this.tex_index,parts:[]}),s.current_frame=l,this.copy_within_command.parts.push({x1:r.x,y1:r.y,x2:h.x,y2:h.y,width:r.width,height:r.height}))}}allocate_icon_state(t){let e=new Map,i=0;for(let s of t.dirs){s.frames.length>1&&i++;for(let t of s.frames)this.hash_to_node.has(t.sprite_hash)||e.set(t.sprite_hash,t.sprite_data)}let s=e.size+i,a=[];for(let e=0;e<s;e++){let e=this.alloc(t.width,t.height);if(!e)break;a.push(e)}if(s!=a.length){for(let t of a)t.free();return!1}let l=a.slice();this.tex_data_command||(this.tex_data_command={cmd:"atlastexdata",index:this.tex_index,parts:[]});for(let[t,i]of e){let e=l.pop();if(!e)break;this.hash_to_node.set(t,e),this.tex_data_command.parts.push(Object.assign({x:e.x,y:e.y},i))}for(let e of t.dirs){for(let t of e.frames){let i=this.hash_to_node.get(t.sprite_hash);t.atlas_node=i,1==e.frames.length&&(e.atlas_node=i,e.current_frame=t)}e.frames.length>1&&(this.add_anim_dir(e),e.atlas_node=l.pop())}return t.atlas=this,!0}add_icon_commands(t){if(this.expand_command&&(t.push(this.expand_command),this.expand_command=void 0),this.tex_data_command){let e=0;for(let t of this.tex_data_command.parts)e+=t.data.length;let i=new Uint8Array(e),s=0;for(let t of this.tex_data_command.parts){let e=i.subarray(s,s+t.data.length);e.set(t.data),t.data=e,s+=t.data.length}this.tex_data_command.transferables=[i.buffer],t.push(this.tex_data_command),this.tex_data_command=void 0}this.copy_within_command&&(t.push(this.copy_within_command),this.copy_within_command=void 0)}}class r{constructor(t,e,i,s,a){this.width=0,this.height=0,this.reserved=!1,this.use_index=0,this.atlas=t,this.parent=e,this.x=i,this.y=s,this.size_index=a,this.largest_avail=a}get full_size(){return 1<<this.size_index}make_children(t){if(this.reserved)throw new Error("Trying to put children on a reserved node");if(this.children)return;let e=this.full_size>>1;this.children=[t||new r(this.atlas,this,this.x,this.y,this.size_index-1),new r(this.atlas,this,this.x+e,this.y,this.size_index-1),new r(this.atlas,this,this.x,this.y+e,this.size_index-1),new r(this.atlas,this,this.x+e,this.y+e,this.size_index-1)],this.update_largest_avail()}alloc(t,e){if(this.reserved)return;if(this.largest_avail<0)return;let i=1<<this.largest_avail,s=this.full_size>>1;if(t>i||e>i)return;if(t>s||e>s){if(this.children)return;return this.reserved=!0,this.width=t,this.height=e,this.update_largest_avail(),this}this.make_children(void 0);let a=this.children;if(a)for(let i=0;i<a.length;i++){let s=a[i];if(s.largest_avail<0)continue;let l=1<<s.largest_avail;if(t<=l&&e<=l){let i=s.alloc(t,e);if(i)return this.update_largest_avail(),i}}}free(){if(!this.reserved)throw new Error("Freeing a non-reserved atlas node");this.reserved=!1,this.unwind()}unwind(){if(this.reserved)return;let t=this.parent;if(t){let e=t.children;if(e){let i=!0;for(let t=0;t<e.length;t++){let s=e[t];if(s.reserved||s.children){i=!1;break}}i&&(this.children=void 0,this.update_largest_avail(),t.unwind())}}}update_largest_avail(){let t=this.children;if(t){this.largest_avail=-1;for(let e=0;e<t.length;e++){let i=t[e];i.largest_avail>this.largest_avail&&(this.largest_avail=i.largest_avail)}}else this.reserved?this.largest_avail=-1:this.largest_avail=this.size_index}}class h{constructor(){this.uses_color_matrices=!1,this.blend_mode=1,this.float_attribs=new Float32Array(1024*this.get_stride())}write_appearance(t,i,s=0,a=0){var l,r,h,n,o,_,d;let c=t*this.get_stride(),f=this.float_attribs;f[c]=1,f[c+1]=0,f[c+2]=0,f[c+3]=0,f[c+4]=1,f[c+5]=0;let u=f.subarray(c,c+6),m=null!==(h=null===(r=null===(l=i.icon_state_dir)||void 0===l?void 0:l.atlas_node)||void 0===r?void 0:r.width)&&void 0!==h?h:32,p=null!==(_=null===(o=null===(n=i.icon_state_dir)||void 0===n?void 0:n.atlas_node)||void 0===o?void 0:o.height)&&void 0!==_?_:32;if(e.matrix_translate(u,-m/2,-p/2),e.matrix_multiply(u,i.transform),e.matrix_translate(u,m/2,p/2),e.matrix_translate(u,s+i.pixel_x+i.pixel_w,a+i.pixel_y+i.pixel_z),null===(d=i.icon_state_dir)||void 0===d?void 0:d.atlas_node){let t=i.icon_state_dir.atlas_node;f[c+6]=t.x,f[c+7]=t.y,f[c+8]=t.x+t.width,f[c+9]=t.y+t.height}else f[c+6]=0,f[c+7]=0,f[c+8]=32,f[c+9]=32;f[c+10]=1-Math.max(Math.min(i.layer/e.MAX_LAYER,1),0);let g=i.color_alpha;this.uses_color_matrices?(f[c+11]=(255&g)/255,f[c+12]=0,f[c+13]=0,f[c+14]=0,f[c+15]=0,f[c+16]=(g>>8&255)/255,f[c+17]=0,f[c+18]=0,f[c+19]=0,f[c+20]=0,f[c+21]=(g>>16&255)/255,f[c+22]=0,f[c+23]=0,f[c+24]=0,f[c+25]=0,f[c+26]=(g>>24&255)/255,f[c+27]=0,f[c+28]=0,f[c+29]=0,f[c+30]=0):(f[c+11]=(255&g)/255,f[c+12]=(g>>8&255)/255,f[c+13]=(g>>16&255)/255,f[c+14]=(g>>24&255)/255)}get_stride(){return this.uses_color_matrices?31:15}get_size(){return Math.floor(this.float_attribs.length/this.get_stride())}expand(){let t=new Float32Array(2*this.get_size()*this.get_stride());t.set(this.float_attribs),this.float_attribs=t}add_draw(t,e,i){var s,a;if(e>=i)return;let l=this.get_stride(),r=this.float_attribs.slice(e*l,i*l);t.push({cmd:"batchdraw",atlas_index:null!==(a=null===(s=this.atlas)||void 0===s?void 0:s.tex_index)&&void 0!==a?a:0,blend_mode:this.blend_mode,data:r,transferables:[r.buffer],num_elements:i-e})}}class n extends class{get_offset(t){return[0,0]}get_click_target(){return null}}{constructor(t){super(),this.ref=t,this.appearance=null,this._loc=null,this.contents=[]}set loc(t){if(t!=this._loc){if(this._loc){let t=this._loc.contents.indexOf(this);t>=0&&this._loc.contents.splice(t,1)}this._loc=t,t&&t.contents.push(this)}}get loc(){return this._loc}get_offset(t){return this._loc instanceof _?this._loc.get_offset(t):[0,0]}get_click_target(){return this}}class o extends n{constructor(){super(...arguments),this.last_loc=null,this.loc_change_time=0}get_offset(t){let[i,s]=super.get_offset(t),a=this.loc;if(!(this.appearance&&this.last_loc instanceof _&&a instanceof _&&a!=this.last_loc&&a.z==this.last_loc.z&&!(t.time<this.loc_change_time)))return[i,s];let l,[r,h]=this.last_loc.get_offset(t),n=r-i,o=h-s;if(Math.abs(n)>32||Math.abs(o)>32)return this.last_loc=null,[i,s];if(l=this.appearance.appearance_flags&e.LONG_GLIDE?Math.max(Math.abs(n),Math.abs(o)):Math.sqrt(n*n+o*o),0==l)return[i,s];let d=l/this.appearance.glide_size*.5,c=Math.max(0,1-(t.time-this.loc_change_time)/d);return[i+n*c,s+o*c]}}class _ extends n{constructor(t,e,i,s){super(t),this.x=e,this.y=i,this.z=s}get_offset(t){return[32*this.x,32*this.y]}}class d{constructor(t,e,i,s,a){this.x=t,this.y=e,this.width=i,this.height=s,this.vertical=a,this.line_thickness=0,this.line_length=0}allocate(t,e){if(!(t>this.width||e>this.height)){if(this.vertical){if(this.width-this.line_thickness<t&&this.height-this.line_length<e)return;if(this.height-this.line_length>=e){let i=this.line_length+this.y;return this.line_length+=e,this.line_thickness=Math.max(this.line_thickness,t),{x:this.x,y:i,width:t,height:e}}return this.x+=this.line_thickness,this.line_length=e,this.line_thickness=t,{x:this.x,y:this.y,width:t,height:e}}if(!(this.width-this.line_length<t&&this.height-this.line_thickness<e)){if(this.width-this.line_length>=t){let i=this.line_length+this.x;return this.line_length+=t,this.line_thickness=Math.max(this.line_thickness,e),{x:i,y:this.y,width:t,height:e}}return this.y+=this.line_thickness,this.line_length=t,this.line_thickness=e,{x:this.x,y:this.y,width:t,height:e}}}}}t.expose(class{constructor(e,i){this.frames=[],this.appearance_cache=[],this.resort_set=new Set,this.atoms=[],this.maxx=0,this.maxy=0,this.maxz=0,this.time=0,this.frame_index=-1,this.clients=new Set,this.client_mobs=new Map,this.resources=[],this.z_level=2,this.use_index=0,this.change_counter=0,this.last_state_str="",this.last_objects=[],this.current_turfs=new Set,this.draw_buffer=new h,this.icon_atlases=[new l(8,12,0)],this.frame_listeners=new Set,this.inspect_listeners=new Map,self.demo_player=this,this.parser_interface=t.wrap(e),this.icon_loader=t.wrap(i),this.parser_interface.consume_data(t.proxy((async t=>{this.rev_data||(this.rev_data=await this.parser_interface.rev_data);for(let e of t.appearances){let t=e;for(let e=0;e<t.overlays.length;e++){let i=t.overlays[e];"number"==typeof i&&(t.overlays[e]=this.appearance_cache[i])}for(let e=0;e<t.underlays.length;e++){let i=t.underlays[e];"number"==typeof i&&(t.underlays[e]=this.appearance_cache[i])}t.sorted_appearances=void 0,t.icon_state_dir=void 0,t.derived_from=t,this.appearance_cache.push(t)}for(let e of t.frames){let t=e;this.dereference_frame_direction(e.forward),this.dereference_frame_direction(e.backward),this.frames.push(t)}for(let e of t.resource_loads){let t=this.get_resource(e.id);if(e.blob&&(t.data=e.blob,t.load_url=void 0),e.path&&(t.path=e.path,!t.data)){let i="data/paintings/public/";e.path.startsWith(i)?t.load_url="https://cdn.yogstation.net/paintings/"+e.path.substring(i.length):t.load_url="https://cdn.jsdelivr.net/gh/yogstation13/yogstation@"+(this.rev_data||"master")+"/"+e.path}t.update()}this.ui&&this.ui.update_duration(this.get_demo_duration()),this.advance_time()}))),this.chat_css=this.parser_interface.chat_css}dereference_frame_direction(t){if(t.set_appearance)for(let[e,i]of t.set_appearance)"number"==typeof i&&t.set_appearance.set(e,this.appearance_cache[i])}adjust_z(t){var e;this.z_level+=t,this.z_level<1&&(this.z_level=1),this.z_level>this.maxz&&(this.z_level=this.maxz),null===(e=this.ui)||void 0===e||e.update_hash(this.z_level)}run_frame(i,s,a,l){var r,h,n;let o;if(0!=s&&this.advance_time_relative(i/100*s),a.follow){let t=new Set,i=a.follow.ref,s="string"==typeof i?this.client_mobs.get(i):i?this.get_atom(i):null;for(;s&&!(s.loc instanceof _);)t.has(s)?s=null:(t.add(s),s=s.loc);if(s&&s.loc instanceof _){let[t,a]=s.get_offset(this);if(s.appearance){let i=e.Appearance.get_display_boundary(s.appearance);t+=i.x+i.width/2,a+=i.y+i.height/2}else t+=16,a+=16;o={ref:i,x:t/32,y:a/32},this.z_level=s.loc.z}else o={ref:i,x:0,y:0};let l=o.x-(null!==(r=a.follow.x)&&void 0!==r?r:(a.right+a.left)/2),n=o.y-(null!==(h=a.follow.y)&&void 0!==h?h:(a.top+a.bottom)/2);a.left+=l,a.right+=l,a.bottom+=n,a.top+=n}let c={left:Math.max(1,Math.floor(a.left-2)),right:Math.min(this.maxx+1,Math.ceil(a.right+2)),bottom:Math.max(1,Math.floor(a.bottom-2)),top:Math.min(this.maxy+1,Math.ceil(a.top+2))},f=.95*a.pixel_scale;f=f>1?Math.ceil(f):2**Math.ceil(Math.log2(f));let u=2*Math.min(1,1/f),m={left:a.left-u,right:a.right+u,bottom:a.bottom-u,top:a.top+u},p=Math.min(8,32*f);m.left=Math.floor(m.left*p)/p,m.right=Math.ceil(m.right*p)/p,m.bottom=Math.floor(m.bottom*p)/p,m.top=Math.ceil(m.top*p)/p;let g=JSON.stringify([c,m,f,this.change_counter,this.time,this.z_level,l,null===(n=a.follow)||void 0===n?void 0:n.ref]);if(g==this.last_state_str)return[];this.last_state_str=g,this.use_index++;for(let t of this.current_turfs)(t.z!=this.z_level||t.x<c.left||t.y<c.bottom||t.x>=c.right||t.y>=c.top)&&this.current_turfs.delete(t);for(let t=c.bottom;t<c.top;t++)for(let e=c.left;e<c.right;e++){let i=this.get_turf(e,t,this.z_level);i&&this.current_turfs.add(i)}let x=[],v=32*(m.right-m.left),w=32*(m.top-m.bottom),y=Math.max(v,w);for(;y*f>4096;)f>2?f--:f/=2;let b,z=[];for(let t of this.current_turfs){t.appearance&&z.push(t);for(let e of t.contents)t.appearance&&z.push(e)}x.push(b={cmd:"viewport",x:0,y:0,width:Math.ceil(v*f),height:Math.ceil(w*f),world_location:{x:m.left,y:m.bottom,width:m.right-m.left,height:m.top-m.bottom}}),this.draw_object_list(x,z),x.push({cmd:"copytoviewport",follow_data:o}),this.last_objects=z;let M=[new d(b.width,0,4096-b.width,b.height,!0),new d(0,b.y,4096,b.height,!1)];for(let t=0;t<l.length;t++){let i=l[t],s=this.get_atom(i.ref),a=s.get_offset(this),r=s.appearance?e.Appearance.get_display_boundary(s.appearance):{x:0,y:0,width:32,height:32};r.x+=a[0],r.y+=a[1],r.width=Math.max(1,r.width),r.height=Math.max(1,r.height);let h=Math.min(i.width/r.width,i.height/r.height);if(h*=.95,h=h>1?Math.ceil(h):2**Math.ceil(Math.log2(h)),r.width/r.height>i.width/i.height){let t=i.height/i.width*r.width-r.height;r.y-=t/2,r.height+=t}else{let t=i.width/i.height*r.height-r.width;r.x-=t/2,r.width+=t}for(;Math.max(r.width,r.height)*h>512;)h>2?h--:h/=2;let n,o=Math.round(h*r.width),_=Math.round(h*r.height);r.width=o/h,r.height=_/h;for(let t of M)if(n=t.allocate(o,_),n)break;n||(x.push({cmd:"flush"}),M=[new d(0,0,4096,4096,!1)],n=M[0].allocate(o,_)),n&&(x.push(Object.assign(Object.assign({cmd:"viewport"},n),{world_location:{x:r.x/32,y:r.y/32,width:r.width/32,height:r.height/32}})),this.draw_object_list(x,[s],101),x.push({cmd:"copytocanvas",canvas_index:t}))}x.push({cmd:"flush"});let k=[];for(let t of this.icon_atlases)t.update_anim_dirs(this.time,this.use_index),t.add_icon_commands(k);k.push(...x);let A=[];for(let t of k)t.transferables&&A.push(...t.transferables);return t.transfer(k,A)}draw_object_list(t,i,s=60){var a,l,r;let h=this.draw_buffer,n=0;i.sort(((t,i)=>{var s,a,l,r,h,n,o,_;let d=e.Appearance.resolve_plane(null!==(a=null===(s=t.appearance)||void 0===s?void 0:s.plane)&&void 0!==a?a:0),c=e.Appearance.resolve_plane(null!==(r=null===(l=i.appearance)||void 0===l?void 0:l.plane)&&void 0!==r?r:0);return d!=c?d-c:(null!==(n=null===(h=t.appearance)||void 0===h?void 0:h.layer)&&void 0!==n?n:0)-(null!==(_=null===(o=i.appearance)||void 0===o?void 0:o.layer)&&void 0!==_?_:0)}));for(let o of i){let[i,_]=o.get_offset(this),d=o.appearance;if(d&&!(d.invisibility>s))for(let s of e.Appearance.get_appearance_parts(d)){if(!s.icon_state_dir){let t=this.get_appearance_dir(s);t&&(s.icon_state_dir=t)}(null===(a=s.icon_state_dir)||void 0===a?void 0:a.atlas_node)&&(h.atlas!=(null===(l=s.icon_state_dir.atlas_node)||void 0===l?void 0:l.atlas)&&(n&&(h.add_draw(t,0,n),n=0),h.atlas=null===(r=s.icon_state_dir.atlas_node)||void 0===r?void 0:r.atlas),s.icon_state_dir.atlas_node.use_index=this.use_index,n>=h.get_size()&&h.expand(),h.write_appearance(n++,s,i,_))}}n&&(h.add_draw(t,0,n),n=0)}get_appearance_dir(t,e){var i;if(null==t.icon)return;let s=this.get_resource(t.icon);if(!s.data)return void s.load();if(!s.icon)return void s.load_icon(this.icon_loader);let a,l=s.icon;if(t.icon_state&&(a=l.icon_states.get(t.icon_state)),a||(a=l.icon_states.get("")),a||(a=l.icon_states.get(" ")),!a)return;a.atlas||this.allocate_icon_state(a,e);let r=null!==(i=[0,1,0,0,2,6,4,2,3,7,5,3,2,1,0,0][t.dir])&&void 0!==i?i:0;return a.dirs[r&a.dirs.length-1]}allocate_icon_state(t,e){if(e&&e.allocate_icon_state(t))return;for(let i of this.icon_atlases)if(i!=e&&i.allocate_icon_state(t))return;console.log("Creating new atlas #"+this.icon_atlases.length);let i=new l(8,12,this.icon_atlases.length);if(this.icon_atlases.push(i),!i.allocate_icon_state(t))throw this.icon_atlases.pop(),t.atlas=null!=e?e:this.icon_atlases[0],new Error("FAILED TO ALLOCATE ICON STATE ("+t.width+", "+t.height+") ATLAS SIZE: "+i.size_index)}get_demo_duration(){return this.frames.length?this.frames[this.frames.length-1].time:0}initialize_ui(){this.ui&&(this.ui.update_time(this.time),this.ui.update_duration(this.get_demo_duration()))}advance_time_relative(t){let e=this.time,i=this.get_demo_duration();if(t<0)e=Math.min(e+t,i);else{if(t>0&&e>=i)return;e=Math.max(Math.min(e+t,i),e)}this.advance_time(e)}advance_time(t=this.time){t<0&&(t=0);let e=this.frame_index;if(t<this.time)for(;this.frames[this.frame_index]&&t<this.frames[this.frame_index].time;)this.undo_frame(this.frames[this.frame_index]),this.time=Math.min(this.time,this.frames[this.frame_index].time),this.frame_index--;else for(;this.frames[this.frame_index+1]&&t>=this.frames[this.frame_index+1].time;)this.frame_index++,this.apply_frame(this.frames[this.frame_index]),this.time=this.frames[this.frame_index].time,this.frames[this.frame_index].time<=0&&(this.frames.splice(this.frame_index,1),this.frame_index--);if(e!=this.frame_index)for(let t of this.frame_listeners)t(this.frame_index);this.time!=t&&this.ui&&this.ui.update_time(t),this.time=t}apply_frame(t){this.apply_frame_direction(t,t.forward,!0),this.change_counter++}undo_frame(t){this.apply_frame_direction(t,t.backward,!1),this.change_counter++}apply_frame_direction(t,e,i=!0){if(e.resize&&([this.maxx,this.maxy,this.maxz]=e.resize,this.adjust_z(0)),e.set_appearance)for(let[t,i]of e.set_appearance){let e=this.get_atom(t);e.appearance=i,this.trigger_inspect_listeners(e),this.resort_set.add(e)}if(e.set_loc)for(let[s,a]of e.set_loc){let e=this.get_atom(s),l=e.loc;i&&e instanceof o&&(e.last_loc=e.loc,e.loc_change_time=t.time),e.loc=a?this.get_atom(a):null,this.trigger_inspect_listeners(l),this.trigger_inspect_listeners(e.loc),this.trigger_inspect_listeners(e),this.resort_set.add(e)}if(e.set_last_loc)for(let[t,i]of e.set_last_loc){let e=this.get_atom(t);e instanceof o&&(e.last_loc=i?this.get_atom(i):null)}if(e.set_loc_change_time)for(let[t,i]of e.set_loc_change_time){let e=this.get_atom(t);e instanceof o&&(e.loc_change_time=i)}if(e.set_client_status)for(let[t,i]of e.set_client_status)i?this.clients.add(t):this.clients.delete(t),this.trigger_inspect_listeners(this.client_mobs.get(t));if(e.set_mob)for(let[t,i]of e.set_mob){let e=this.client_mobs.get(t);i?(this.client_mobs.set(t,this.get_atom(i)),this.trigger_inspect_listeners(this.get_atom(i))):this.client_mobs.delete(t),this.trigger_inspect_listeners(e)}}get_chat_messages(t="world",e=0,i=this.frames.length){e=Math.max(0,e),i=Math.min(i,this.frames.length);let s=[];for(let a=e;a<i;a++){let e=this.frames[a];if(e.chat)for(let i of e.chat)(i.clients.includes(t)||i.clients.includes("world"))&&s.push({message:i.message,frame_index:a,time:e.time})}return s}add_frame_listener(e){let s=i.despam_promise(e);return this.frame_listeners.add(s),s(this.frame_index),t.proxy((()=>{this.frame_listeners.delete(s),e[t.releaseProxy]()}))}add_inspect_listener(e,s){let a=this.get_atom(e),l=i.despam_promise((async()=>{var t,i,l,r;let h={name:null!==(i=null===(t=a.appearance)||void 0===t?void 0:t.name)&&void 0!==i?i:"null",ref:e,clients:this.get_object_clients(a),loc:a.loc?{name:null!==(r=null===(l=a.loc.appearance)||void 0===l?void 0:l.name)&&void 0!==r?r:"null",ref:a.loc.ref}:null,contents:a.contents.map((t=>{var e,i;return{name:null!==(i=null===(e=t.appearance)||void 0===e?void 0:e.name)&&void 0!==i?i:"null",ref:t.ref}}))};try{await s(h)}catch(t){console.error(t)}}));l();let r=this.inspect_listeners.get(a);return r||this.inspect_listeners.set(a,r=[]),r.push(l),t.proxy((()=>{var e;let i=null!==(e=null==r?void 0:r.indexOf(l))&&void 0!==e?e:-1;i>=0&&(null==r||r.splice(i,1)),(null==r?void 0:r.length)||this.inspect_listeners.get(a)!=r||this.inspect_listeners.delete(a),s[t.releaseProxy]()}))}trigger_inspect_listeners(t){if(!t)return;let e=this.inspect_listeners.get(t);if(e)for(let t of e)t()}get_object_clients(t){if(t.ref>>24!=3)return[];let e=[];for(let[i,s]of this.client_mobs)s==t&&this.clients.has(i)&&e.push(i);return e}get_objects_through_point(t,i){var s,a,l,r;let h=[],n=new Set,o=this.get_turf(Math.floor(t),Math.floor(i),this.z_level);o&&(n.add(o),h.push({name:null!==(a=null===(s=o.appearance)||void 0===s?void 0:s.name)&&void 0!==a?a:"null",ref:o.ref,clients:[]}));for(let s of this.last_objects){let a=s.get_click_target();if(!a||n.has(a))continue;let[o,_]=s.get_offset(this);s.appearance&&e.Appearance.check_appearance_click(s.appearance,32*t-o,32*i-_,!0)&&(n.add(a),h.push({name:null!==(r=null===(l=a.appearance)||void 0===l?void 0:l.name)&&void 0!==r?r:"null",ref:a.ref,clients:this.get_object_clients(a)}))}return h.reverse(),h}get_clicked_object_ref(t,i){let s=this.last_objects;for(let a=s.length-1;a>=0;a--){let l=s[a],r=l.get_click_target();if(!r)continue;let[h,n]=l.get_offset(this);if(l.appearance&&e.Appearance.check_appearance_click(l.appearance,32*t-h,32*i-n,!1))return r.ref}}get_clients_mobs(){var t,e,i;let s=[];for(let a of[...this.clients].sort()){let l=this.client_mobs.get(a);s.push({name:null!==(e=null===(t=null==l?void 0:l.appearance)||void 0===t?void 0:t.name)&&void 0!==e?e:"null",ref:null!==(i=null==l?void 0:l.ref)&&void 0!==i?i:0,ckey:a})}return s}get_atom(t){let e=(4278190080&t)>>>24,i=16777215&t,s=this.atoms[e];s||(s=this.atoms[e]=[]);let a=s[i];if(!a){if(1==e){let e=i%this.maxx+1,s=Math.floor(i/this.maxx),l=s%this.maxy+1,r=Math.floor(s/this.maxy)+1;a=new _(t,e,l,r)}else a=3==e||2==e?new o(t):new n(t);s[i]=a}return a}get_turf(t,e,i){if(t<1||t>this.maxx)return;if(e<1||e>this.maxy)return;if(i<1||i>this.maxz)return;let s=t-1+16777216+(e-1+(i-1)*this.maxy)*this.maxx;return this.get_atom(s)}get_resource(t){let e=this.resources[t];return e||(e=new s(t),e.icon_load_callbacks.push((()=>{this.change_counter++})),this.resources[t]=e),e}})}));
