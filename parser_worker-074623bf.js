if(!self.define){let e,r={};const t=(t,a)=>(t=new URL(t+".js",a).href,r[t]||new Promise((r=>{if("document"in self){const e=document.createElement("script");e.src=t,e.onload=r,document.head.appendChild(e)}else e=t,importScripts(t),r()})).then((()=>{let e=r[t];if(!e)throw new Error(`Module ${t} didnâ€™t register its module`);return e})));self.define=(a,s)=>{const i=e||("document"in self?document.currentScript.src:"")||location.href;if(r[i])return;let n={};const c=e=>t(e,i),_={module:{uri:i},exports:n,require:c};r[i]=Promise.all(a.map((e=>_[e]||c(e)))).then((e=>(s(...e),n)))}}define(["./comlink-9648aa2d","./appearance-ffb0e256"],(function(e,r){"use strict";let t=()=>{};function a(e,r,t){return"number"==typeof e?65535==(16777215&e)?0:e:null==e?0:16777216|e[0]-1+r*(e[1]-1+t*(e[2]-1))}class s extends class{constructor(e,r){this.frame_callbacks=e,this.set_rev_data=r,this.running_atoms=[],this.running_size=[0,0,0],this.running_clients=new Set,this.running_client_mobs=new Map,this.duration=0,this.frames=[],this.last_progress=-1,this.appearance_id_cache=new Map,this.appearance_cache=[],this.resource_loads=[],this.current_frame={time:0,forward:{}},self.demo_parser=this}update_progress(e,r=!1){this.progress_callback&&(e<this.last_progress+.005&&!r||(this.last_progress=e,this.progress_callback(e,r)))}push_frame(e){var r;if(null==e&&(e=this.current_frame.time),e<this.current_frame.time)throw new Error(`Can't go back in time, dummy. Old time is ${this.current_frame.time}, attempted to go back to ${e}`);if(!function(e){for(let r of Object.keys(e.forward))return!1;return!e.chat}(this.current_frame)){let e=Object.assign(Object.assign({},this.current_frame),{backward:{}});if(e.forward.set_appearance){e.backward.set_appearance=new Map;for(let[r,t]of e.forward.set_appearance){let a=this.get_running_atom(r);e.backward.set_appearance.set(r,a.appearance),a.appearance=t}}if(e.forward.set_loc){e.backward.set_loc=new Map,e.backward.set_last_loc||(e.backward.set_last_loc=new Map),e.backward.set_loc_change_time||(e.backward.set_loc_change_time=new Map);for(let[r,t]of e.forward.set_loc){let a=this.get_running_atom(r);e.backward.set_loc.set(r,a.loc),e.backward.set_last_loc.set(r,a.last_loc),e.backward.set_loc_change_time.set(r,a.loc_change_time),a.loc_change_time=this.current_frame.time,a.last_loc=a.loc,a.loc=t}}if(e.forward.set_client_status){e.backward.set_client_status=new Map;for(let[r,t]of e.forward.set_client_status)e.backward.set_client_status.set(r,this.running_clients.has(r)),t?this.running_clients.add(r):this.running_clients.delete(r)}if(e.forward.set_mob){e.backward.set_mob=new Map;for(let[t,a]of e.forward.set_mob)e.backward.set_mob.set(t,null!==(r=this.running_client_mobs.get(t))&&void 0!==r?r:0),this.running_client_mobs.set(t,a)}e.forward.resize&&(e.backward.resize=this.running_size,this.running_size=e.forward.resize),this.frames.push(e)}this.duration=this.current_frame.time,this.current_frame={time:e,forward:{}};for(let e of this.frame_callbacks)e();this.frame_callbacks.length=0}get_running_atom(e){let r=(4278190080&e)>>>24,t=16777215&e,a=this.running_atoms[r];a||(a=this.running_atoms[r]=[]);let s=a[t];return s||(s=a[t]={appearance:null,loc:0,loc_change_time:0,last_loc:0}),s}set_appearance(e,r){this.current_frame.forward.set_appearance||(this.current_frame.forward.set_appearance=new Map),this.current_frame.forward.set_appearance.set(e,r)}set_loc(e,r){this.current_frame.forward.set_loc||(this.current_frame.forward.set_loc=new Map),this.current_frame.forward.set_loc.set(e,r)}set_client_status(e,r){this.current_frame.forward.set_client_status||(this.current_frame.forward.set_client_status=new Map),this.current_frame.forward.set_client_status.set(e,r)}set_mob(e,r){this.current_frame.forward.set_mob||(this.current_frame.forward.set_mob=new Map),this.current_frame.forward.set_mob.set(e,r)}resize(e,r,t){this.push_frame(),this.current_frame.forward.resize=[e,r,t]}add_chat(e){this.current_frame.chat||(this.current_frame.chat=[]),this.current_frame.chat.push(e)}appearance_id(e){if(null==e)return null;let r=JSON.stringify(Object.values(e)),t=this.appearance_id_cache.get(r);return null!=t||(t=this.appearance_cache.length,this.appearance_id_cache.set(r,t),this.appearance_cache.push(e)),t}appearance_from_id(e){return null==e?null:this.appearance_cache[e]}}{constructor(){super(...arguments),this.text_decoder=new TextDecoder,this.partial_line="",this.version=-1,this.line_counter=1,this.maxx=0,this.maxy=0,this.maxz=0,this.turf_levels_loaded=0,this.obj_levels_loaded=0,this.null_loaded=!0,this.last_chat="",this.icon_cache=[],this.icon_state_caches=[],this.name_cache=[],this.resource_id_cache=new Map,this.resource_id_counter=0}async handle_data(e){this.partial_line+=this.text_decoder.decode(e,{stream:!0});let r=this.partial_line.split(/\r?\n/g);this.partial_line=r[r.length-1],r.length--;for(let e of r){this.handle_line(e)&&await new Promise((e=>setTimeout(e,16)))}}handle_line(e){var r,t,s,n;if(this.version<0){if(!e.startsWith("demo version "))throw new Error("No version");let r=+e.split(" ")[2];if(!(r>=1&&r<=1))throw new Error("Unsupported demo version "+r);return this.version=r,this.line_counter++,!1}if(this.turf_levels_loaded<this.maxz)return this.handle_turf_zlevel(e,++this.turf_levels_loaded),this.line_counter++,this.push_frame(),!0;if(this.obj_levels_loaded<this.maxz)return this.handle_obj_zlevel(e,++this.obj_levels_loaded),this.line_counter++,this.push_frame(),!0;if(!this.null_loaded&&this.maxz)return this.handle_obj_zlevel(e,null),this.null_loaded=!0,this.line_counter++,this.push_frame(),this.update_progress(1,!0),!0;let c=/^([a-z]+) /i.exec(e);if(!c)throw new Error("Could not parse line: "+e);let _=c[1],h=e.substring(_.length+1),o=new i(h,this.line_counter++,_.length+1);if("commit"==_)console.log("Commit "+h),this.set_rev_data(h);else if("init"==_)[this.maxx,this.maxy,this.maxz]=h.split(" ").map((e=>parseInt(e))),this.resize(this.maxx,this.maxy,this.maxz),this.null_loaded=!1;else if("time"==_)this.push_frame(+h);else if("new"==_)for(;o.idx<o.txt.length;){let e=o.read_ref();o.read_expected_char(" ");let r=a(o.read_loc(null),this.maxx,this.maxy);o.read_expected_char(" ");let t=this.read_appearance(o);this.set_appearance(e,this.appearance_id(t)),this.set_loc(e,r),","==o.curr()&&o.idx++}else if("del"==_)for(;o.idx<o.txt.length;){let e=o.read_ref();","==o.curr()&&o.idx++,this.set_appearance(e,null),this.set_loc(e,0)}else if("update"==_)for(;o.idx<o.txt.length;){let e=o.read_ref();o.read_expected_char(" ");let i=null!==(t=null===(r=this.current_frame.forward.set_loc)||void 0===r?void 0:r.get(e))&&void 0!==t?t:this.get_running_atom(e).loc,n=a(o.read_loc(i),this.maxx,this.maxy);o.read_expected_char(" ");let c=null===(s=this.current_frame.forward.set_appearance)||void 0===s?void 0:s.get(e);void 0===c&&(c=this.get_running_atom(e).appearance);let _=this.appearance_id(this.read_appearance(o,this.appearance_from_id(c)));i!=n&&this.set_loc(e,n),c!=_&&this.set_appearance(e,_),","==o.curr()&&o.idx++}else if("turf"==_)for(;o.idx<o.txt.length;){o.read_expected_char("(");let e=a(o.read_loc(null),this.maxx,this.maxy);o.read_expected_char(")"),o.read_expected_char("=");let r=null===(n=this.current_frame.forward.set_appearance)||void 0===n?void 0:n.get(e);void 0===r&&(r=this.get_running_atom(e).appearance);let t=this.appearance_id(this.read_appearance(o,this.appearance_from_id(r)));this.set_appearance(e,t),","==o.curr()&&o.idx++}else if("login"==_)this.set_client_status(h,!0);else if("logout"==_)this.set_client_status(h,!1),this.set_mob(h,0);else if("setmob"==_){let e=h.indexOf(" ");if(e<0)throw new Error("Setmob needs ckey and mob reference");o.idx=e+1;let r=h.substring(0,e),t=o.read_ref();this.set_mob(r,t)}else if("chat"==_){let e=/^([^ ]+) (.+)$/.exec(h);if(!e)throw new Error("Malformed chat");let r=e[1].split(","),t=e[2];"="==t?t=this.last_chat:(t=JSON.parse(t),this.last_chat=t),this.add_chat({clients:r,message:t})}else console.warn("Unrecognized command "+_);return!1}handle_turf_zlevel(e,r){let t=new i(e,this.line_counter,0),a=16777216+(r-1)*this.maxx*this.maxy,s=0,n=null,c=!1,_=this.maxx*this.maxy;for(;t.idx<t.txt.length;){if("0123456789".includes(t.curr())){let e=t.read_number();for(let t=1;t<e;t++)c&&(n=this.appearance_id(this.get_space_appearance(s%this.maxx+1,Math.floor(s/this.maxx)+1,r))),this.set_appearance(a+s++,n)}else"s"==t.curr()?(t.idx++,n=this.appearance_id(this.get_space_appearance(s%this.maxx+1,Math.floor(s/this.maxx)+1,r)),c=!0):(n=this.appearance_id(this.read_appearance(t,this.appearance_from_id(n),!0)),c=!1),this.set_appearance(a+s++,n);if(this.update_progress((r-1+(t.idx+1)/t.txt.length)/this.maxz*.4,!1),s>_)throw new Error(`Exceeded z-level size at ${t}`);","==t.curr()&&t.idx++}if(s!=this.maxx*this.maxy)throw new Error(`Z-level of size ${this.maxx}x${this.maxy} should have ${this.maxx*this.maxy} turfs, has ${s} turfs`)}handle_obj_zlevel(e,r){let t=new i(e,this.line_counter,0),a=null===r?0:16777216+(r-1)*this.maxx*this.maxy,s=0;for(;t.idx<t.txt.length;){if("0123456789".includes(t.curr())?s+=t.read_number():this.read_init_obj(t,a&&a+s),null!=r?this.update_progress(.4+(r-1+(t.idx+1)/t.txt.length)/this.maxz*.4,!1):this.update_progress(.8+(t.idx+1)/t.txt.length*.2,!1),s>this.maxx*this.maxy)throw new Error(`Exceeded z-level size at ${t}`);","==t.curr()&&t.idx++}}read_init_obj(e,r){let t=e.read_ref();this.set_loc(t,r),e.read_expected_char("=");let a=this.read_appearance(e);if(this.set_appearance(t,this.appearance_id(a)),"("==e.curr()){for(e.idx++;")"!=e.curr();){if(this.read_init_obj(e,t),!"),".includes(e.txt[e.idx]))throw new Error(`Expected ) or , at ${e}, found ${e.curr()} instead`);","==e.curr()&&e.idx++}e.idx++}}get_icon_resource(e){if(null==e)return null;let r=this.resource_id_cache.get(e);return null!=r||(r=++this.resource_id_counter,this.resource_id_cache.set(e,r),e&&this.resource_loads.push({id:r,path:e})),r}get_space_appearance(e=0,t=0,a=0){return Object.assign(Object.assign({},r.ReaderAppearance.base),{icon:this.get_icon_resource("icons/turf/space.dmi"),icon_state:""+((e+t^~(e*t)+a)%25+25)%25,name:"space",layer:1.8,plane:-95})}read_appearance(e,t=null,a=!0){if("n"==e.curr())return e.idx++,null;if("="==e.curr())return e.idx++,t;if("s"==e.curr()||"t"==e.curr()){let t=Object.assign(Object.assign({},r.ReaderAppearance.base),{icon:this.get_icon_resource("icons/turf/space.dmi"),icon_state:"1",name:"space",layer:1.8,plane:-95});return"t"==e.curr()&&(e.idx++,t.dir=+e.curr(),1==t.dir?t.transform=[-1,0,0,0,-1,0]:4==t.dir?t.transform=[0,-1,0,1,0,0]:8==t.dir&&(t.transform=[0,1,0,-1,0,0]),t.icon_state="speedspace_ns_?"),e.idx++,t}let s,i;if("~"==e.curr()?(e.idx++,t?(s=Object.assign({},t),a||(s.overlays=[],s.underlays=[])):(console.warn(`Comparison to null at ${e}`),s=Object.assign({},r.ReaderAppearance.base))):s=Object.assign({},r.ReaderAppearance.base),e.read_expected_char("{"),"}"==e.curr())return e.idx++,s;if(";"!=e.curr())if('"'==e.curr())s.icon=this.get_icon_resource(e.read_string()),this.icon_cache.push(s.icon),i=[],this.icon_state_caches.push(i);else if("n"==e.curr())e.idx+=4,s.icon=null,this.icon_cache.push(s.icon),i=[],this.icon_state_caches.push(i);else{let r=e.read_number();s.icon=this.icon_cache[r-1],i=this.icon_state_caches[r-1]}if(e.read_next_or_end())return s;if(";"!=e.curr()){if(!i)throw console.error(this.icon_cache),console.error(i),new Error(`Unknown icon at ${e}`);if('"'==e.curr())s.icon_state=e.read_string(),i.push(s.icon_state);else if("n"==e.curr())e.idx+=4,s.icon_state=null,i.push(s.icon_state);else{let r=e.read_number();s.icon_state=i[r-1]}}if(e.read_next_or_end())return s;if(";"!=e.curr()&&('"'==e.curr()?(s.name=e.read_string(),this.name_cache.push(s.name)):"n"==e.curr()?(e.idx+=4,s.name=null,this.name_cache.push(s.name)):s.name=this.name_cache[e.read_number()-1]),e.read_next_or_end())return s;if(";"!=e.curr()&&(s.appearance_flags=e.read_number()),e.read_next_or_end())return s;if(";"!=e.curr()&&(s.layer=e.read_number()),e.read_next_or_end())return s;if(";"!=e.curr()&&(s.plane=e.read_number()),e.read_next_or_end())return s;if(";"!=e.curr()&&(s.dir=e.read_number()),e.read_next_or_end())return s;if(";"!=e.curr())if("w"==e.curr())s.color_alpha=16777215|s.color_alpha,e.idx++;else if("#"==e.curr()){let r=e.txt.substring(e.idx+5,e.idx+7)+e.txt.substring(e.idx+3,e.idx+5)+e.txt.substring(e.idx+1,e.idx+3);s.color_alpha=parseInt(r,16)|4278190080&s.color_alpha,e.idx+=7}else{let r=[];for(;"-.0123456789".includes(e.curr());)r.push(e.read_number()/255),","==e.curr()&&e.idx++}if(e.read_next_or_end())return s;if(";"!=e.curr()&&(s.color_alpha=16777215&s.color_alpha|Math.min(255,Math.max(0,e.read_number()))<<24),e.read_next_or_end())return s;if(";"!=e.curr()&&(s.pixel_x=e.read_number()),e.read_next_or_end())return s;if(";"!=e.curr()&&(s.pixel_y=e.read_number()),e.read_next_or_end())return s;if(";"!=e.curr()&&(s.blend_mode=e.read_number()),e.read_next_or_end())return s;if(";"!=e.curr())if("i"==e.curr())s.transform=r.ReaderAppearance.base.transform,e.idx++;else{s.transform=[1,0,0,0,1,0];let r=0;for(;"-.0123456789".includes(e.curr());)s.transform[r++]=e.read_number(),","==e.curr()&&e.idx++}if(e.read_next_or_end())return s;if(";"!=e.curr()&&(s.invisibility=e.read_number()),e.read_next_or_end())return s;if(";"!=e.curr()&&(s.pixel_w=e.read_number()),e.read_next_or_end())return s;if(";"!=e.curr()&&(s.pixel_z=e.read_number()),e.read_next_or_end())return s;if("["==e.curr()){for(s.overlays=[];"[,".includes(e.curr())&&(e.idx++,"]"!=e.curr());){let r=this.read_appearance(e,s,!1);r&&s.overlays.push(this.appearance_id(r))}if("["!=e.curr()||s.overlays.length||e.idx++,"]"!=e.curr())throw new Error(`Expected ] or , at ${e}, found ${e.curr()} instead`);e.idx++}if(e.read_next_or_end())return s;if("["==e.curr()){for(s.underlays=[];"[,".includes(e.curr())&&(e.idx++,"]"!=e.curr());){let r=this.read_appearance(e,s,!1);r&&s.underlays.push(this.appearance_id(r))}if("["!=e.curr()||s.underlays.length||e.idx++,"]"!=e.curr())throw new Error(`Expected ] or , at ${e}, found ${e.curr()} instead`);e.idx++}return e.read_expected_char("}"),s}}class i{constructor(e,r,t=0){this.txt=e,this.line=r,this.offset=t,this.idx=0}curr(){return this.txt[this.idx]}toString(e=this.idx){return`${this.line}:${e+this.offset+1}`}read_number(){let e=this.idx;for(;"1234567890.-eE".includes(this.curr());)this.idx++;return+this.txt.substring(e,this.idx)}read_ref(){if("["!=this.curr())throw new Error(`Expected [ at ${this}, found ${this.curr()} instead.`);let e=this.idx;for(;"[0x123456789abcdefABCDEF".includes(this.curr());)this.idx++;if("]"!=this.curr())throw new Error(`Expected ] at ${this}, found ${this.curr()} instead.`);this.idx++;let r=this.txt.substring(e+1,this.idx-1);return r.startsWith("0x")?+r:+r+33554432}read_loc(e){if("="==this.curr())return this.idx++,e;if("["==this.curr())return this.read_ref();if("n"==this.curr())return this.idx+=4,null;{let e=this.read_number();if(","!=this.curr())throw new Error(`Expected , at ${this}, found ${this.curr()} instead`);this.idx++;let r=this.read_number();if(","!=this.curr())throw new Error(`Expected , at ${this}, found ${this.curr()} instead`);return this.idx++,[e,r,this.read_number()]}}read_string(){let e=this.idx;if('"'!=this.curr())return"";for(this.idx++;'"'!=this.curr();)"\\"==this.curr()&&this.idx++,this.idx++;return this.idx++,JSON.parse(this.txt.substring(e,this.idx))}read_next_or_end(){if("}"==this.curr())return this.idx++,!0;if(";"!=this.curr())throw new Error(`Expected ; or } at ${this}, got ${this.curr()} instead`);return this.idx++,!1}read_expected_char(e){if(this.curr()!=e){let r=e;throw" "==r&&(r='" "'),new Error(`Expected ${r} at ${this}, found ${this.curr()} instead`)}this.idx++}}e.expose(new class{constructor(){this._frame_callbacks=[],this.rev_data=function(){let e=t,r=t,a=new Promise(((t,a)=>{e=t,r=a}));return e=e.bind(a),r=r.bind(a),Object.assign(a,{resolve:e,reject:r})}(),this.chat_css=this.rev_data.then((async e=>{let r=["tgui/packages/tgui-panel/styles/goon/chat-dark.scss","code/modules/goonchat/browserassets/css/browserOutput.css"],t="";e:for(let a of r)try{t="",a instanceof Array||(a=[a]);for(let r of a){let a=await fetch("https://cdn.jsdelivr.net/gh/Yogstation13/yogstation@"+e+"/"+r);if(!a.ok)continue e;t+=await a.text()}break}catch(e){console.error(e)}return t})),this._consuming_data=!1}async handle_data(e){this._parser||(this._parser=new s(this._frame_callbacks,this.rev_data.resolve),this._progress_callback&&(this._parser.progress_callback=this._progress_callback)),await this._parser.handle_data(e)}async wait_for_frames(e){for(;!(this._parser&&this._parser.frames.length>e);)await new Promise((e=>this._frame_callbacks.push(e)));return this._parser.frames.length}async consume_data(e){if(this._consuming_data)throw new Error("Data already being consumed");let r=0;for(;;){if(await this.wait_for_frames(0),!this._parser)continue;let t={frames:this._parser.frames.slice(0),appearances:this._parser.appearance_cache.slice(r),resource_loads:this._parser.resource_loads.slice(0)};this._parser.frames.length=0,this._parser.resource_loads.length=0,r=this._parser.appearance_cache.length,await e(t)}}async set_progress_callback(e){this._parser&&(this._parser.progress_callback=e),this._progress_callback=e}})}));
